---
import AdminLayout from "@/layouts/AdminLayout.astro";
import * as userSql from "@/sql/userSql";

const { user } = Astro.locals;
if (user === null) {
  return Astro.redirect("/login");
}
const { MY_DB } = Astro.locals.runtime.env;

let message = "";
let messageType = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action") as string;
  const targetUserId = formData.get("userId") as string;
  
  if (action === "toggle_allowed") {
    try {
      await userSql.toggleUserAllowedSql(MY_DB, targetUserId);
      message = "用户状态已更新";
      messageType = "success";
    } catch (error) {
      message = "更新失败: " + error;
      messageType = "error";
    }
  }
}

const allUsers = await userSql.selectAllUsersSql(MY_DB);
---

<AdminLayout title="User Manager">
  <div class="space-y-12 mx-auto max-w-7xl">
    <div class="border-b border-white/10 pb-12">
      <h2 class="text-base font-semibold leading-7 text-white">
        用户管理
      </h2>
      <p class="mt-1 text-sm leading-6 text-gray-400">
        管理允许登录的用户列表
      </p>

      {message && (
        <div class={`mt-4 p-4 rounded-md ${
          messageType === "success" 
            ? "bg-green-900/50 text-green-200 border border-green-700" 
            : "bg-red-900/50 text-red-200 border border-red-700"
        }`}>
          {message}
        </div>
      )}

      <div class="mt-10">
        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-800">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  用户名
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  邮箱
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  状态
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  操作
                </th>
              </tr>
            </thead>
            <tbody class="bg-gray-900 divide-y divide-gray-700">
              {allUsers.map((userItem) => (
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                    {userItem.username}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                    {userItem.email}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                      userItem.is_allowed 
                        ? "bg-green-900 text-green-200" 
                        : "bg-red-900 text-red-200"
                    }`}>
                      {userItem.is_allowed ? "允许" : "禁止"}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <form method="post" class="inline">
                      <input type="hidden" name="action" value="toggle_allowed" />
                      <input type="hidden" name="userId" value={userItem.id} />
                      <button
                        type="submit"
                        class={`px-3 py-1 rounded text-xs font-medium ${
                          userItem.is_allowed
                            ? "bg-red-600 hover:bg-red-700 text-white"
                            : "bg-green-600 hover:bg-green-700 text-white"
                        }`}
                      >
                        {userItem.is_allowed ? "禁止" : "允许"}
                      </button>
                    </form>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>